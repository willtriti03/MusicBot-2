# 음성 명령어 기능 사용 가이드

MusicBot에 **실제 음성 인식 기능**이 추가되었습니다! 이제 음성 채널에서 직접 말로 봇을 제어할 수 있습니다. 📢

## 🎯 두 가지 사용 방법

### 1. 텍스트 기반 음성 명령어 (항상 사용 가능)
텍스트 채널에서 봇 이름과 함께 자연스러운 한국어로 명령할 수 있습니다.

### 2. 실제 음성 인식 (NEW! 🆕)
음성 채널에서 직접 말로 봇을 제어할 수 있습니다. Google Speech Recognition API를 사용합니다.

## 설정 방법

### 1. 환경 변수 설정

프로젝트 루트의 `.env` 파일에서 봇 이름을 설정하세요:

```env
# 봇 이름 설정 (음성으로 부를 이름)
BOT_NAME=뮤직봇
```

원하는 이름으로 변경할 수 있습니다. 예:
- `BOT_NAME=지니`
- `BOT_NAME=디제이`
- `BOT_NAME=음악`

### 2. 의존성 설치

새로운 의존성을 설치하세요:

```bash
pip install -r requirements.txt
```

필수 패키지:
- `python-dotenv` - 환경 변수 로드
- `SpeechRecognition` - 음성 인식
- `PyAudio` - 오디오 처리 (선택사항, 일부 환경에서 필요)

## 사용 방법

### 방법 1: 텍스트 기반 음성 명령어

Discord 텍스트 채널에서 봇 이름과 함께 명령어를 입력하세요:

```
뮤직봇 재생 노래제목
```

명령어 앞에 `!`나 다른 prefix를 붙일 필요가 없습니다!

### 방법 2: 실시간 음성 인식 🎤 (NEW!)

**실시간 스트리밍 방식**으로 작동합니다! 봇이 음성 채널에서 계속 듣고 있다가 이름이 불리면 즉시 반응합니다.

#### 2-1. 음성 인식 활성화

1. 먼저 봇을 음성 채널로 소환합니다:
```
!summon
```

2. 음성 듣기를 시작합니다:
```
!listen
```

✅ 봇이 이제 **실시간으로** 음성 채널에서 여러분의 음성을 듣고 있습니다! 🎧

#### 2-2. 음성으로 명령하기

음성 채널에서 직접 말하세요 (언제든지!):

```
"뮤직봇 재생 BTS Dynamite"
"뮤직봇 다음"
"뮤직봇 멈춰"
```

**🚀 실시간 처리:**
- 1초마다 오디오 버퍼를 자동으로 처리
- 봇 이름이 감지되면 **즉시 반응**
- 여러 사용자의 음성을 동시에 처리 가능
- 명령어 인식 시 텍스트 채널에 알림

#### 2-3. 음성 인식 중지

```
!stoplisten
```

### 지원되는 음성 명령어

#### 🎵 재생 관련

| 음성 명령어 | 예시 | 설명 |
|------------|------|------|
| 재생 / 플레이 / 틀어줘 / 들려줘 | `뮤직봇 재생 아이유` | 노래 재생 |
| 일시정지 / 멈춰 / 정지 | `뮤직봇 멈춰` | 재생 일시정지 |
| 다시재생 / 계속 / 다시 | `뮤직봇 계속` | 재생 재개 |
| 스킵 / 건너뛰기 / 넘겨 / 다음 | `뮤직봇 다음` | 다음 곡으로 스킵 |

#### 📋 대기열 관련

| 음성 명령어 | 예시 | 설명 |
|------------|------|------|
| 큐 / 대기열 / 목록 | `뮤직봇 목록` | 재생 목록 확인 |
| 지금재생 / 현재곡 / 지금곡 | `뮤직봇 지금곡` | 현재 재생 중인 곡 확인 |
| 셔플 / 섞기 / 랜덤 | `뮤직봇 셔플` | 대기열 섞기 |
| 클리어 / 전부삭제 / 다지워 | `뮤직봇 클리어` | 대기열 전체 삭제 |

#### 🔊 볼륨 및 설정

| 음성 명령어 | 예시 | 설명 |
|------------|------|------|
| 볼륨 / 음량 / 소리 | `뮤직봇 볼륨 50` | 볼륨 조절 |
| 반복 / 리피트 | `뮤직봇 반복` | 반복 재생 설정 |

#### 🤖 봇 제어

| 음성 명령어 | 예시 | 설명 |
|------------|------|------|
| 와 / 이리와 / 소환 | `뮤직봇 와` | 봇을 음성 채널로 소환 |
| 나와 / 종료 / 끊어 / 그만 | `뮤직봇 나와` | 음성 채널에서 나가기 |

## 사용 예시

### 예시 1: 노래 재생
```
뮤직봇 재생 https://www.youtube.com/watch?v=...
```
또는
```
뮤직봇 틀어줘 BTS Dynamite
```

### 예시 2: 재생 제어
```
사용자: 뮤직봇 멈춰
봇: [음악이 일시정지됩니다]

사용자: 뮤직봇 계속
봇: [음악이 다시 재생됩니다]

사용자: 뮤직봇 다음
봇: [다음 곡으로 넘어갑니다]
```

### 예시 3: 대기열 관리
```
사용자: 뮤직봇 목록
봇: [현재 대기열을 표시합니다]

사용자: 뮤직봇 셔플
봇: [대기열을 섞습니다]
```

### 예시 4: 볼륨 조절
```
사용자: 뮤직봇 볼륨 30
봇: [볼륨을 30%로 설정합니다]
```

## 명령어 매핑

음성 명령어는 다음과 같이 기존 봇 명령어로 자동 변환됩니다:

| 음성 명령어 | 봇 명령어 |
|------------|-----------|
| 재생 / 플레이 / 틀어줘 | `!play` |
| 일시정지 / 멈춰 | `!pause` |
| 다시재생 / 계속 | `!resume` |
| 스킵 / 다음 | `!skip` |
| 큐 / 목록 | `!queue` |
| 지금곡 | `!np` |
| 볼륨 | `!volume` |
| 셔플 | `!shuffle` |
| 반복 | `!repeat` |
| 나와 | `!disconnect` |
| 와 / 소환 | `!summon` |
| 클리어 | `!clear` |

## 기술적 세부사항

### 작동 원리

1. 사용자가 텍스트 채널에 메시지를 입력합니다
2. 봇이 메시지에서 설정된 봇 이름을 감지합니다
3. 봇 이름 뒤의 한국어 명령어를 파싱합니다
4. 해당하는 영어 명령어로 변환합니다
5. 기존 봇 명령어 처리 로직으로 전달됩니다

### 파일 구조

```
MusicBot-2/
├── .env                           # 봇 이름 설정
├── musicbot/
│   ├── bot.py                     # 메인 봇 로직 (음성 명령어 통합)
│   ├── voice_commands.py          # 음성 명령어 파서
│   └── voice_recognition.py       # 음성 인식 모듈 (향후 확장용)
├── requirements.txt               # 의존성 목록
└── VOICE_COMMANDS.md             # 이 문서
```

### 🔥 실시간 음성 인식 동작 원리

**RealtimeAudioSink**를 사용한 스트리밍 방식:

1. **실시간 음성 수신** 🎤
   - Discord의 audio sink를 통해 사용자의 음성을 **연속적으로** 수신
   - 각 사용자별로 독립적인 오디오 버퍼 유지

2. **지능형 버퍼 관리** 🔄
   - 1초마다 자동으로 버퍼 처리 (비동기)
   - 최대 5초까지 오디오 버퍼링 (메모리 절약)
   - 중복 처리 방지 (Lock 메커니즘)

3. **즉시 음성-텍스트 변환** ⚡
   - Google Speech Recognition API 사용
   - 한국어로 실시간 변환
   - 배경 소음 자동 조정

4. **봇 이름 감지** 🔔
   - 변환된 텍스트에서 봇 이름 검색
   - 감지 시 즉시 텍스트 채널에 알림

5. **명령어 파싱 및 실행** 🚀
   - 봇 이름 뒤의 한국어 명령어 파싱
   - 영어 명령어로 변환
   - 실시간 명령어 실행

**⚡ 성능 최적화:**
- 사용자별 독립적인 처리 (다중 사용자 동시 지원)
- 비동기 처리로 블로킹 없음
- 불필요한 짧은 오디오 자동 필터링

### 새로운 명령어

| 명령어 | 설명 |
|--------|------|
| `!listen` | 음성 채널에서 음성 인식 시작 |
| `!stoplisten` | 음성 인식 중지 |

## 문제 해결

### 텍스트 기반 음성 명령어 관련

#### 봇이 텍스트 음성 명령어를 인식하지 못해요

1. `.env` 파일의 `BOT_NAME` 설정을 확인하세요
2. 메시지에 정확한 봇 이름이 포함되어 있는지 확인하세요
3. 봇을 재시작해보세요

#### 명령어가 작동하지 않아요

1. 로그를 확인하여 명령어가 올바르게 파싱되는지 확인하세요
2. 기존 봇 명령어 (`!play` 등)가 정상 작동하는지 확인하세요
3. 봇이 해당 명령어를 실행할 권한이 있는지 확인하세요

### 실제 음성 인식 관련

#### 봇이 내 음성을 인식하지 못해요

1. **인터넷 연결 확인**: Google Speech Recognition API는 인터넷 연결이 필요합니다
2. **마이크 권한**: Discord에서 마이크 권한이 활성화되어 있는지 확인하세요
3. **명확한 발음**: 봇 이름을 명확하게 발음해주세요
4. **배경 소음**: 조용한 환경에서 테스트해보세요
5. **로그 확인**: 봇 콘솔에서 "Recognized speech" 로그가 나오는지 확인하세요

#### `!listen` 명령어가 작동하지 않아요

1. **봇이 음성 채널에 있는지 확인**: 먼저 `!summon`으로 봇을 소환하세요
2. **Discord.py 버전**: Discord.py 2.0+ 버전이 필요합니다
3. **FFmpeg 설치**: FFmpeg가 시스템에 설치되어 있어야 합니다

```bash
# macOS
brew install ffmpeg

# Ubuntu/Debian
sudo apt-get install ffmpeg

# Windows
# https://ffmpeg.org/download.html 에서 다운로드
```

#### 음성 인식 응답이 느려요

- Google Speech Recognition은 무료 API라 응답 시간이 다소 걸릴 수 있습니다
- 더 빠른 응답을 원한다면 Google Cloud Speech API 유료 버전이나 다른 STT 서비스 사용을 고려하세요

### 의존성 설치 오류

#### PyAudio 설치 오류

macOS에서 PyAudio 설치 시 오류가 발생하면:

```bash
brew install portaudio
pip install pyaudio
```

Windows에서:

```bash
pip install pipwin
pipwin install pyaudio
```

Ubuntu/Debian:

```bash
sudo apt-get install python3-pyaudio
```

#### 기타 의존성 문제

```bash
# 전체 재설치
pip uninstall -r requirements.txt -y
pip install -r requirements.txt
```

## 개발자 정보

### 로깅

음성 명령어 처리는 INFO 레벨에서 로깅됩니다:

```python
log.info(f"Detected voice command: {message_content}")
log.info(f"Converted voice command to: {new_content}")
```

디버그 모드에서는 더 자세한 로그를 확인할 수 있습니다.

### 새로운 명령어 추가

`musicbot/voice_commands.py`의 `command_map` 딕셔너리에 새로운 매핑을 추가하세요:

```python
self.command_map = {
    # ... 기존 명령어들
    "새명령어": "newcommand",
}
```

## 라이선스

이 기능은 MusicBot의 기존 라이선스를 따릅니다.

## 기여

버그 리포트나 기능 제안은 GitHub Issues를 통해 제출해주세요.

---

**즐거운 음악 감상 되세요! 🎵**
